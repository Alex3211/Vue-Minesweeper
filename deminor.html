<html>

<head>
  <title>Example</title>
</head>

<body>
  <div id="menu">
  </div>
  <div id="app"></div>
</body>

</html>
<script>
  const generateArray = () => {
    let array = [];
    for (let rowIndex = 0; rowIndex < 11; rowIndex++) {
      let row = [];
      for (let colIndex = 0; colIndex < 22; colIndex++) row.push({
        "bombe": false,
        "value": 0
      });
      array.push(row);
    }
    return array;
  }
  const array = generateArray();
  const game = (function manager() {
    const app = {
      data: {
        menuContent: [{
          fv: 'Score',
          value: 0
        }, {
          fv: 'rejouer'
        }, {
          fv: ''
        }, {
          fv: ''
        }, {
          fv: ''
        }],
        menu: null
      },
      launch: (app) => {
        const plateau = document.getElementById('app');
        plateau.innerHTML = "";
        app.uiManager.setMenu(app);
        app.grid.GenerateBomb(array.length, array[0].length);
        app.grid.setNumber(app.grid.AdjacentBomb);
        array.forEach((e, i) => {
          const parent = app.grid.row(e, i, plateau)
          e.forEach((secondElement, secondIndex) => {
            app.grid.col(e, parent, i, secondIndex)
          })
        })
      },
      grid: {
        row: (e, i, plateau) => {
          const element = document.createElement('DIV')
          element.className = 'row'
          element['data-attribute'] = {
            type: 0
          }
          return plateau.appendChild(element)
        },
        col: (e, parent, firstIndex, secondIndex) => {
          const element = document.createElement('DIV')
          element.className = 'col'
          element['data-attribute'] = {
            type: 1,
            pos: {
              row: firstIndex,
              col: secondIndex
            },
            ...array[firstIndex][secondIndex]
          }
          // DEBUG
          // element.innerHTML = array[firstIndex][secondIndex].value + `${array[firstIndex][secondIndex].bombe}`;
          parent.appendChild(element)
          element.onclick = (u) => {


              if (u.target['data-attribute'].bombe) {
                u.target.className = `${u.target.className} red`
                setTimeout(() => {
                  confirm('Loose! Relaunching') ? app.launch(app) : null;
                  app.data.menuContent[1].score = 0;
                }, 100);
              } else {
                checkCase(u);
              }

            },
            checkCase = (u) => {
              if (!u.target.className.includes('green')) {
                u.target.className = `${u.target.className} green`;
                if (u.target['data-attribute'].value !== 0) {
                  app.data.menuContent[1].value = app.data.menuContent[1].value + u.target['data-attribute'].value;
                  document.getElementsByClassName('score')[0].innerHTML =
                    `Score: ${app.data.menuContent[1].value}`
                  u.target.innerHTML = u.target['data-attribute'].value;
                }
                let plateau = document.getElementById('app');
                let countFalse = 0;
                let countTrue = 0;
                Object.values(plateau.children).forEach(row => {
                  Object.values(row.children).forEach(column => {
                    if (column['data-attribute'].value && !column.className.includes('green')) {
                      countTrue = countTrue + 1;
                    } else {
                      countFalse = countFalse + 1;
                    }
                  })
                })
                if (countTrue === 0) {
                  setTimeout(() => {
                    confirm('Win! Relaunching') ? app.launch(app) : null;
                    app.data.menuContent[1].score = 0;
                  }, 100);
                }
                if (u.target['data-attribute'].value === 0) {
                  let adjacent = getAdjacentCase(u);
                  adjacent.forEach((e, i) => {
                    checkCase(e)
                  });
                }
              }
            },
            getAdjacentCase = (origin) => {
              let plateau = document.getElementById('app');
              let originValues = {
                x: origin.target['data-attribute'].pos.row,
                y: origin.target['data-attribute'].pos.col
              }
              let adjacentValidCase = [];

              for (let i = -1; i <= 1; i++) {
                for (let t = -1; t <= 1; t++) {
                  const current = [];
                  Object.values(plateau.children).forEach(row => {
                    Object.values(row.children).forEach(column => {
                      if (column['data-attribute'].pos.row === i + originValues.x && column[
                          'data-attribute'].pos.col === t + originValues.y) current.push(column);
                    })
                  })

                  if (current[0] && ((!current[0].className.includes('green') && !current[0].className.includes(
                      'red')))) {
                    adjacentValidCase.push({
                      target: current[0]
                    });
                  }
                }
              }
              return adjacentValidCase;
            }
        },
        setNumber: (adjacentFunction) => {

          array.forEach((row, i) => {
            row.forEach((column, t) => {
              if (!column.bombe) {
                array[i][t].value = adjacentFunction(t, i, array.length - 1, row.length - 1);
              }
            })
          })
        },
        AdjacentBomb: (colIndex, rowIndex, rowLenght, colLenght) => {
          let bombNumber = 0;
          for (let o = -1; o <= 1; o++) {
            for (let l = -1; l <= 1; l++) {
              if ((rowIndex + o) < 0 || (rowIndex + o) > rowLenght ||
                (colIndex + l) < 0 || (colIndex + l) > colLenght ||
                (l !== 0 && o !== 0) && colIndex === 11 && rowIndex === 11) {
                continue;
              }
              if (array[rowIndex + o][colIndex + l].bombe) {
                bombNumber++;
              }
            }
          }
          return bombNumber;
        },
        GenerateBomb: (colLength, rowLength) => {
          let caseNumber = 0;
          array.forEach((e, i) => {
            e.forEach((secondElement, secondIndex) => {
              caseNumber++;
              secondElement.bombe = false;
              secondElement.value = 0;
            })
          })
          let bombNumber = caseNumber * 0.2;
          for (var i = 0; i < bombNumber; i++) {
            let x = Math.floor(Math.random() * Math.floor(colLength));
            let y = Math.floor(Math.random() * Math.floor(rowLength));
            if (!array[x][y].bombe) {
              array[x][y].bombe = true;
            } else {
              i--;
            }
          }
        }
      },
      uiManager: {
        setOnclickListener: (id, funct) => document.getElementById(id).onclick = funct,
        setMenu: (app) => {
          const menu = document.getElementById('menu');
          menu.innerHTML = "";
          app.data.menuContent[1].value = 0;
          app.data.menuContent.forEach(e => {
            const element = document.createElement('DIV')
            element.innerHTML = e.fv;
            element.className = `btn ${e.fv}`;
            if (e.fv.includes(app.data.menuContent[0].fv)) {
              element.innerHTML = `${e.fv}: ${e.value}`
            }
            if (e.fv === app.data.menuContent[1].fv) {
              element.onclick = (e) => app.launch(app);
            }

            menu.appendChild(element);
          });
        }
      }
    }
    app.launch(app);
    return manager;
  })()
</script>
<style>
  /*
    #232323: gris foncé
    #262631: gris/bleu foncé
    #1d1d25: gris/bleu a peine plus foncé
    #626468: gris
    #e30613: rouge
    #318EAF: bleu
  */
  * {
    margin: 0;
    box-sizing: border-box;
  }

  body {
    background: #262631;
  }

  #menu {
    width: 100%;
    height: 10vh;
    display: flex;
    min-height: 64px;
    background: #1d1d25;

  }

  .btn {
    height: 100%;
    width: 20%;
    font-size: 20px;
    border: 1px solid black;
    display: flex;
    justify-content: center;
    align-items: center;
    color: #626468;
  }

  .btn:hover {
    font-size: 24px;
    cursor: pointer;
    color: #626468;
  }

  #app {
    margin: 0 auto;
    height: 90vh;
    padding-top: 0px;
  }

  .row {
    display: flex;
    height: calc(100% / 11);
    min-height: 64px;

  }

  .col {
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 24px;
    width: calc(100vw / 22);
    height: 100%;
    border: 1px solid black;
  }

  .col:hover {
    cursor: pointer;
  }

  .red {
    background: #e30613;
  }

  .green {
    background: #318EAF;
  }
</style>